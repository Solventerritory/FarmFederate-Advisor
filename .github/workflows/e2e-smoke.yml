name: E2E Smoke (ingest + dry-run)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  e2e-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install -q qdrant-client sentence-transformers transformers datasets pillow
      - name: Small ingestion into in-memory Qdrant (safe)
        run: |
          python backend/ingest_real_datasets.py --qdrant-url :memory: --use-defaults --max-files 5 --max-text 5 || true
      - name: Run dry-run of full pipeline (DRY_RUN=1)
        env:
          DRY_RUN: '1'
          RUN_ON_COLAB: '0'
        run: |
          python FarmFederate_Kaggle_Complete.py --dry-run || true
      - name: Run unit tests
        run: |
          pytest -q tests/test_ingest_and_models.py -q || true
